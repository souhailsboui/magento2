<?php

use MageMe\WebForms\Block\Customer\Account\Result\MessageForm;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var MessageForm $block */
/** @var Escaper $escaper */

/** @var Template $tiny_mce */
$tiny_mce = $this->getLayout()->createBlock('Magento\Framework\View\Element\Template',
    null, [
        'data' => [
            'require_tinymce' => 'mage/adminhtml/wysiwyg/tiny_mce/setup',
            'field_uid'       => 'mm-message'
        ]
    ])
    ->setTemplate('MageMe_WebForms::form/element/field/type/wysiwyg/tiny_mce.phtml');
?>

<div class="webforms-message-form">
    <div class="block">
        <div class="block-title">
            <strong><?= __('Reply') ?></strong>
        </div>
        <div class="block-content">
            <form id="<?= $block->getFormId() ?>" method="post" enctype="multipart/form-data"
                  action="<?= $escaper->escapeUrl($block->getSubmitUrl()); ?>">
                <input name="form_key" type="hidden" value=""/>
                <fieldset class="fieldset" data-hasrequired="<?= __('* Required Fields') ?>">
                    <div class="field required">
                        <label class="label" for="mm-message"><span><?= __('Message') ?></span></label>
                        <textarea id='mm-message'
                                  name='message'
                                  class='mm-message mceEditor validate-hidden'
                                  data-validate="{'required-entry':true}" aria-required="true"
                        ></textarea>
                    </div>
                    <div class="field">
                        <input id="<?= $block->getDropzoneId() ?>"
                               class="mm-message-attachment"
                               type="file"
                               name="<?= $block->getDropzoneName() ?>"
                               data-uid="<?= $block->getDropzoneUid() ?>"/>
                    </div>
                </fieldset>
                <div class="actions-toolbar">
                    <div class="primary">
                        <button type="submit" class="action submit primary"
                                title="<?= __('Submit'); ?>">
                            <span><?= __('Submit'); ?></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<?= $tiny_mce->toHtml(); ?>

<script>
    require(['MageMe_WebForms/js/dropzone'], function (Dropzone) {
        new Dropzone({
            uid: '<?= $block->getDropzoneUid() ?>',
            url: '<?= $block->getDropzoneUrl()?>',
            fieldId: '<?= $block->getDropzoneId()?>',
            fieldName: '<?= $block->getDropzoneName()?>',
            dropZoneText: '<?= $block->getDropzoneText()?>',
            maxFiles: <?php var_export($block->getDropzoneMaxFiles())?>,
            allowedSize: <?php var_export($block->getDropzoneAllowedSize())?>,
            restrictedExtensions: <?= json_encode($block->getDropzoneRestrictedExtensions(), true); ?>,
            containerId: "<?= $block->getFormId() ?>"
        });

    });
</script>

<script>
    require(['jquery', 'MageMe_WebForms/js/validation'], function ($, initValidation) {
        document.getElementById('<?= $block->getFormId() ?>').onsubmit = (e) => {
            e.preventDefault();
            const form = $("#<?= $block->getFormId() ?>");
            form.validation({
                ignore: ':hidden:not(.validate-hidden)',
                errorPlacement: function (error, element) {
                    if (element.hasClass('mceEditor')) {
                        element.next().after(error);
                    }
                }
            });
            initValidation();
            if (!(form.validation() && form.validation('isValid'))) {
                return false;
            }
            e.target.submit();
            e.target.disable();
        }
    });
</script>

